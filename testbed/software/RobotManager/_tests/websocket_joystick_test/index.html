<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Websocket Joystick Test</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; padding: 24px; background: #0b1020; color: #e7ecff; }
    .card { background: #121a37; border: 1px solid #243059; border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
    label { font-size: 12px; opacity: .8; }
    input, button { padding: 10px 12px; border-radius: 10px; border: 1px solid #33406b; background: #0f152e; color: #e7ecff; outline: none; }
    input:focus { border-color: #5a7cff; box-shadow: 0 0 0 2px rgba(90,124,255,.25); }
    button { background: linear-gradient(180deg, #2a3a7a, #1f2b5b); cursor: pointer; }
    button:active { transform: translateY(1px); }
    .small { font-size: 12px; opacity: .8; }
    .muted { opacity: .7; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
    .badge { padding: 2px 8px; border-radius: 999px; background: #1e2b57; border: 1px solid #2b3a72; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .log { max-height: 240px; overflow: auto; background: #0d132a; border: 1px solid #1c2550; border-radius: 10px; padding: 10px; white-space: pre-wrap; }
    hr { border: none; border-top: 1px solid #223061; margin: 16px 0; }
  </style>
</head>
<body>
  <h1>Websocket Joystick Test</h1>

  <div class="card" style="margin-bottom:16px;">
    <div class="row">
      <div>
        <label for="host">Host</label><br/>
        <input id="host" value="localhost" class="mono" style="min-width: 200px;" />
      </div>
      <div>
        <label for="port">Port</label><br/>
        <input id="port" type="number" value="8765" class="mono" style="width: 120px;" />
      </div>
      <div style="align-self: end;">
        <button id="startBtn">Start Manager</button>
        <button id="rescanBtn">Rescan Pads</button>
        <button id="clearLogBtn" title="Clear logs">üßπ</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div class="badge" id="mgrStatus">manager: idle</div>
      <div class="badge" id="counts">connected: 0</div>
      <div class="small muted">Tip: press any button on your controller after plugging it in so the browser recognizes it.</div>
    </div>
  </div>

  <div class="grid" id="pads"></div>

  <div class="card" style="margin-top:16px;">
    <div class="row" style="justify-content: space-between;">
      <div><strong>Event Log</strong></div>
      <div class="small muted">Button events (forwarded to backend) & local axis snapshots</div>
    </div>
    <hr/>
    <div id="log" class="log mono"></div>
  </div>

  <script type="module">
    import { WebsocketJoystickManager } from './src/websocket_joystick.js';
    import { Joystick } from './src/joystick.js';

    const el = (id) => document.getElementById(id);
    const padsWrap = el('pads');
    const mgrStatus = el('mgrStatus');
    const counts = el('counts');
    const logEl = el('log');

    let manager = null;
    let raf = null;

    function log(line) {
      const ts = new Date().toLocaleTimeString();
      logEl.textContent += `[${ts}] ${line}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function render() {
      if (!manager) return;

      const list = manager.list();
      counts.textContent = `connected: ${list.length}`;

      padsWrap.innerHTML = '';
      for (const item of list) {
        // item: { key, index, id, mapping, axes, buttons, joystickConnected, websocketConnected }
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div><strong>Joystick #${item.index}</strong></div>
            <div class="row">
              <div class="badge">${item.mapping ?? 'unknown'}</div>
              <div class="badge">${item.joystickConnected ? 'pad:on' : 'pad:off'}</div>
              <div class="badge">${item.websocketConnected ? 'ws:on' : 'ws:off'}</div>
            </div>
          </div>
          <div class="small mono muted" style="margin-top:6px;">${item.id ?? ''}</div>
          <hr/>
          <div class="mono small">Axes: <span id="axes-${item.index}">[]</span></div>
          <div class="mono small">Buttons analog: <span id="btns-${item.index}">[]</span></div>
        `;
        padsWrap.appendChild(card);

        // Live local values (queried straight from the Joystick)
        const wj = manager.get(item.index);
        if (wj && wj.joystick) {
          const axesSpan = card.querySelector(`#axes-${item.index}`);
          const btnsSpan = card.querySelector(`#btns-${item.index}`);
          const axes = wj.joystick.getAxes();
          const btns = wj.joystick.getButtons().map(b => Number(b.value.toFixed(3)));
          axesSpan.textContent = JSON.stringify(axes.map(v => Number(v.toFixed(3))));
          btnsSpan.textContent = JSON.stringify(btns);
        }
      }

      raf = requestAnimationFrame(render);
    }

    function attachPerJoystickLogging() {
      if (!manager) return;

      // For each WebsocketJoystick, log frontend button events (forwarded over WS automatically)
      const list = manager.list();
      for (const item of list) {
        const wj = manager.get(item.index);
        if (!wj || !wj.joystick || wj._logHooked) continue;

        wj._logHooked = true;
        wj.joystick.callbacks.get('button').register(evt => {
          log(`btn [idx:${evt.index}${evt.name ? `, name:${evt.name}` : ''}] ${evt.type} v=${evt.value.toFixed(3)} pressed=${evt.pressed}`);
        });
      }
    }

    el('startBtn').addEventListener('click', () => {
      // Tear down previous
      if (manager) {
        manager.destroy?.();
        manager = null;
        if (raf) cancelAnimationFrame(raf);
      }

      const host = el('host').value || 'localhost';
      const port = Number(el('port').value || 8765);

      try {
        manager = new WebsocketJoystickManager({ host, port, autoStart: true });
        mgrStatus.textContent = `manager: running (ws://${host}:${port})`;

        // The underlying JoystickManager will emit new_joystick via callbacks,
        // but our wrapper doesn't expose callbacks ‚Äî we'll poll + hook when present.
        setInterval(attachPerJoystickLogging, 500);

        if (raf) cancelAnimationFrame(raf);
        render();
        log(`Manager started for ws://${host}:${port}`);
      } catch (e) {
        console.error(e);
        log(`Error starting manager: ${e?.message || e}`);
        mgrStatus.textContent = 'manager: error';
      }
    });

    el('rescanBtn').addEventListener('click', () => {
      if (!manager) return;
      manager.joystick_manager?.rescan?.();
      log('Manual rescan requested');
    });

    el('clearLogBtn').addEventListener('click', () => {
      logEl.textContent = '';
    });

    // Helpful hint if Gamepad API isn't supported
    if (!('getGamepads' in navigator)) {
      log('‚ö†Ô∏è This browser does not support the Gamepad API.');
    } else {
      log('Press any button on your controller after plugging it in so the browser recognizes it.');
    }
  </script>
</body>
</html>